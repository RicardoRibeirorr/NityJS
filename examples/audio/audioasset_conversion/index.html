<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioAsset Usage Example - NityJS</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #1a1a2e;
            color: white;
        }
        .example-panel {
            background: #0f3460;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            max-width: 800px;
        }
        .code-block {
            background: #16213e;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }
        button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #357abd;
        }
        .log {
            background: #16213e;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üéµ AudioAsset with Automatic AudioClip Conversion</h1>
    <p>Demonstrating seamless AudioAsset to AudioClip conversion for AudioSource compatibility</p>
    
    <div class="example-panel">
        <h3>üìñ How It Works:</h3>
        <p>AudioAsset now provides a complete <code>toAudioClip()</code> conversion that includes all methods and properties needed by AudioSourceComponent:</p>
        
        <div class="code-block">
// 1. Create AudioAsset (automatically loads and registers)
const jumpSound = new AudioAsset("jump", "assets/sounds/jump.wav");

// 2. Use directly with AudioSourceComponent via registry name
const audioSource = new AudioSourceComponent();
audioSource.setClip("jump"); // Looks up in registry and converts automatically

// 3. Or convert manually for direct use
const audioClip = jumpSound.toAudioClip();
audioSource.setClip(audioClip);

// 4. All AudioClip methods are now available:
console.log(audioClip.length);        // Duration in seconds
console.log(audioClip.createSourceNode()); // Web Audio source node
audioSource.play(); // Works perfectly!
        </div>
        
        <h3>üîß Generated Methods & Properties:</h3>
        <ul>
            <li><strong>Properties:</strong> name, url, audioBuffer, audioContext, length, channels, frequency, isLoaded</li>
            <li><strong>Methods:</strong> load(), isReady(), createSourceNode(), getInfo(), dispose()</li>
            <li><strong>Getters:</strong> isReady (property), state</li>
            <li><strong>Compatibility:</strong> 100% compatible with AudioSourceComponent</li>
        </ul>
        
        <button onclick="testDirectUsage()">üéØ Test Direct AudioAsset Usage</button>
        <button onclick="testRegistryUsage()">üìö Test Registry Lookup Usage</button>
        <button onclick="testConversionMethods()">üî¨ Test Conversion Methods</button>
        <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
        
        <div id="log" class="log"></div>
    </div>

    <script type="module">
        import { AudioAsset, AudioSourceComponent, GameObject, Vector2 } from '../../../dist/nity.module.js';
        
        window.AudioAsset = AudioAsset;
        window.AudioSourceComponent = AudioSourceComponent;
        window.GameObject = GameObject;
        window.Vector2 = Vector2;
        
        const logDiv = document.getElementById('log');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.style.color = type === 'error' ? '#e74c3c' : type === 'success' ? '#27ae60' : '#ffffff';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(div);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // Test direct AudioAsset usage
        window.testDirectUsage = async function() {
            log('üéØ Testing direct AudioAsset usage...', 'info');
            
            try {
                // Create a simple test tone
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const sampleRate = audioContext.sampleRate;
                const duration = 0.3;
                const frequency = 600; // Higher pitched beep
                
                const buffer = audioContext.createBuffer(1, sampleRate * duration, sampleRate);
                const data = buffer.getChannelData(0);
                
                for (let i = 0; i < data.length; i++) {
                    data[i] = Math.sin(2 * Math.PI * frequency * i / sampleRate) * 0.2;
                }
                
                // Create mock AudioAsset
                const mockAsset = {
                    name: 'direct_test',
                    audioPath: 'generated://direct_test',
                    audioBuffer: buffer,
                    audioContext: audioContext,
                    isLoaded: true,
                    
                    getDuration: () => duration,
                    getChannelCount: () => 1,
                    getSampleRate: () => sampleRate,
                    isReady: () => true,
                    load: () => Promise.resolve(),
                    getInfo: () => ({ name: 'direct_test', duration: duration }),
                    dispose: () => {}
                };
                
                // Apply our conversion method
                const toAudioClip = AudioAsset.prototype.toAudioClip;
                const audioClip = toAudioClip.call(mockAsset);
                
                log('‚úÖ AudioAsset created and converted to AudioClip', 'success');
                log(`üìä Clip info: ${audioClip.name}, ${audioClip.length}s, ${audioClip.channels}ch`);
                
                // Create AudioSource and play
                const gameObject = new GameObject(new Vector2(100, 100));
                const audioSource = new AudioSourceComponent();
                gameObject.addComponent(audioSource);
                
                audioSource.setClip(audioClip);
                audioSource.spatial = false;
                audioSource.volume = 0.3;
                
                log('üîä Playing direct AudioAsset audio...');
                const playResult = audioSource.play();
                
                if (playResult) {
                    log('üéµ Audio playback started successfully!', 'success');
                    setTimeout(() => {
                        audioSource.stop();
                        log('‚èπÔ∏è Audio stopped');
                    }, 500);
                } else {
                    log('‚ùå Failed to start audio playback', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Direct usage test failed: ${error.message}`, 'error');
                console.error(error);
            }
        };
        
        // Test registry lookup usage
        window.testRegistryUsage = function() {
            log('üìö Testing AudioRegistry lookup usage...', 'info');
            
            try {
                // This would normally work with real audio files
                log('‚ÑπÔ∏è Registry lookup requires real audio files to be loaded');
                log('üí° Example: audioSource.setClip("jump_sound") looks up "jump_sound" in AudioRegistry');
                log('üîÑ AudioRegistry automatically calls toAudioClip() when retrieving assets');
                log('‚úÖ This provides seamless integration with existing AudioAsset workflow', 'success');
                
            } catch (error) {
                log(`‚ùå Registry test failed: ${error.message}`, 'error');
            }
        };
        
        // Test conversion methods
        window.testConversionMethods = function() {
            log('üî¨ Testing AudioClip conversion methods...', 'info');
            
            try {
                // Create mock asset
                const mockAsset = {
                    name: 'method_test',
                    audioPath: 'test://method_test',
                    audioBuffer: null,
                    audioContext: new (window.AudioContext || window.webkitAudioContext)(),
                    isLoaded: false,
                    
                    getDuration: () => 1.5,
                    getChannelCount: () => 2,
                    getSampleRate: () => 44100,
                    isReady: () => false,
                    load: () => Promise.resolve(),
                    getInfo: () => ({ name: 'method_test', duration: 1.5 }),
                    dispose: () => log('üóëÔ∏è Asset disposed')
                };
                
                const toAudioClip = AudioAsset.prototype.toAudioClip;
                const audioClip = toAudioClip.call(mockAsset);
                
                // Test all methods and properties
                log(`üìã name: "${audioClip.name}"`);
                log(`‚è±Ô∏è length: ${audioClip.length}s`);
                log(`üîä channels: ${audioClip.channels}`);
                log(`üìª frequency: ${audioClip.frequency}Hz`);
                log(`üîç isReady (property): ${audioClip.isReady}`);
                log(`üîç isReady (method): ${audioClip.isReady()}`);
                log(`üìä state: "${audioClip.state}"`);
                
                // Test methods
                log('üß™ Testing load() method...');
                audioClip.load().then(() => {
                    log('‚úÖ load() method executed successfully');
                });
                
                log('üß™ Testing createSourceNode() method...');
                const sourceNode = audioClip.createSourceNode();
                if (sourceNode === null) {
                    log('‚ö†Ô∏è createSourceNode() returned null (expected for unloaded audio)');
                } else {
                    log('‚úÖ createSourceNode() returned valid node');
                }
                
                log('üß™ Testing getInfo() method...');
                const info = audioClip.getInfo();
                log(`üìÑ getInfo(): ${JSON.stringify(info)}`);
                
                log('‚úÖ All conversion methods tested successfully!', 'success');
                
            } catch (error) {
                log(`‚ùå Conversion method test failed: ${error.message}`, 'error');
                console.error(error);
            }
        };
        
        window.clearLog = function() {
            logDiv.innerHTML = '';
        };
        
        // Auto-run a basic test
        setTimeout(() => {
            log('üöÄ AudioAsset conversion system ready!');
            log('üí° Click buttons above to test different usage patterns');
        }, 500);
    </script>
</body>
</html>

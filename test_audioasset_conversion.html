<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioAsset to Clip Conversion Test - NityJS</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #1a1a2e;
            color: white;
        }
        .test-panel {
            background: #0f3460;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            max-width: 800px;
        }
        .test-result {
            background: #16213e;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
        }
        .success { border-left: 4px solid #27ae60; }
        .error { border-left: 4px solid #e74c3c; }
        .warning { border-left: 4px solid #f39c12; }
        button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #357abd;
        }
    </style>
</head>
<body>
    <h1>üéµ AudioAsset to AudioClip Conversion Test</h1>
    <p>Testing proper conversion from AudioAsset to AudioClip format</p>
    
    <div class="test-panel">
        <h3>Test Results:</h3>
        <div id="testResults"></div>
        
        <button onclick="runTests()">üî¨ Run Conversion Tests</button>
        <button onclick="testAudioPlayback()">‚ñ∂Ô∏è Test Audio Playback</button>
        <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
    </div>

    <script type="module">
        import { AudioAsset, AudioSourceComponent } from '../../src/index.js';
        
        window.AudioAsset = AudioAsset;
        window.AudioSourceComponent = AudioSourceComponent;
        
        const resultsDiv = document.getElementById('testResults');
        
        function addResult(message, type = 'success') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = message;
            resultsDiv.appendChild(div);
        }
        
        // Test conversion functionality
        window.runTests = async function() {
            addResult('üî¨ Starting AudioAsset to AudioClip conversion tests...', 'warning');
            
            try {
                // Create a test audio asset (using a dummy path for testing)
                const audioAsset = new AudioAsset('test_sound', 'data:audio/wav;base64,UklGRjQAAABXQVZFZm10IBAAAAABAAEAABAfAAAEAQABAAgAAAABAQEAAQEBAAAB');
                
                addResult('‚úÖ AudioAsset created successfully');
                
                // Convert to AudioClip
                const audioClip = audioAsset.toAudioClip();
                
                addResult('‚úÖ AudioAsset.toAudioClip() executed without errors');
                
                // Test required properties
                const requiredProperties = ['name', 'audioContext', 'length', 'channels', 'frequency', 'isLoaded'];
                for (const prop of requiredProperties) {
                    if (audioClip.hasOwnProperty(prop) || audioClip[prop] !== undefined) {
                        addResult(`‚úÖ Property '${prop}' exists: ${audioClip[prop]}`);
                    } else {
                        addResult(`‚ùå Missing property: ${prop}`, 'error');
                    }
                }
                
                // Test required methods
                const requiredMethods = ['load', 'isReady', 'createSourceNode'];
                for (const method of requiredMethods) {
                    if (typeof audioClip[method] === 'function') {
                        addResult(`‚úÖ Method '${method}' exists and is callable`);
                    } else {
                        addResult(`‚ùå Missing or invalid method: ${method}`, 'error');
                    }
                }
                
                // Test isReady as both property and method
                try {
                    const readyProp = audioClip.isReady;
                    const readyMethod = audioClip.isReady();
                    addResult(`‚úÖ isReady property: ${readyProp}, method: ${readyMethod}`);
                } catch (error) {
                    addResult(`‚ùå isReady access failed: ${error.message}`, 'error');
                }
                
                // Test createSourceNode method
                try {
                    const sourceNode = audioClip.createSourceNode();
                    if (sourceNode === null) {
                        addResult('‚ö†Ô∏è createSourceNode() returned null (expected if audio not loaded)', 'warning');
                    } else {
                        addResult('‚úÖ createSourceNode() returned valid node');
                    }
                } catch (error) {
                    addResult(`‚ùå createSourceNode() failed: ${error.message}`, 'error');
                }
                
                // Test compatibility with AudioSourceComponent
                try {
                    const audioSource = new AudioSourceComponent();
                    audioSource.setClip(audioClip);
                    addResult('‚úÖ AudioClip compatible with AudioSourceComponent.setClip()');
                } catch (error) {
                    addResult(`‚ùå AudioSourceComponent compatibility failed: ${error.message}`, 'error');
                }
                
                addResult('üéØ Conversion tests completed!', 'warning');
                
            } catch (error) {
                addResult(`‚ùå Test failed: ${error.message}`, 'error');
                console.error('Test error:', error);
            }
        };
        
        // Test actual audio playback
        window.testAudioPlayback = async function() {
            addResult('üîä Testing audio playback with converted clip...', 'warning');
            
            try {
                // Create a simple beep tone for testing
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Create a simple tone buffer
                const sampleRate = audioContext.sampleRate;
                const duration = 0.5; // 0.5 seconds
                const frequency = 440; // A4 note
                
                const buffer = audioContext.createBuffer(1, sampleRate * duration, sampleRate);
                const data = buffer.getChannelData(0);
                
                for (let i = 0; i < data.length; i++) {
                    data[i] = Math.sin(2 * Math.PI * frequency * i / sampleRate) * 0.3;
                }
                
                // Create mock AudioAsset with real audio buffer
                const mockAsset = {
                    name: 'test_beep',
                    audioPath: 'generated://beep',
                    audioBuffer: buffer,
                    audioContext: audioContext,
                    isLoaded: true,
                    
                    getDuration: () => duration,
                    getChannelCount: () => 1,
                    getSampleRate: () => sampleRate,
                    isReady: () => true,
                    load: () => Promise.resolve(),
                    getInfo: () => ({ name: 'test_beep', duration: duration }),
                    dispose: () => {}
                };
                
                // Apply our toAudioClip method
                const toAudioClip = AudioAsset.prototype.toAudioClip;
                const audioClip = toAudioClip.call(mockAsset);
                
                addResult('‚úÖ Generated test audio clip with real buffer');
                
                // Test with AudioSourceComponent
                const audioSource = new AudioSourceComponent();
                audioSource.setClip(audioClip);
                audioSource.spatial = false; // 2D audio for testing
                audioSource.volume = 0.3;
                
                addResult('‚úÖ AudioSourceComponent configured with converted clip');
                
                // Try to play
                const playResult = audioSource.play();
                if (playResult) {
                    addResult('üéµ Audio playback started successfully!');
                    
                    // Stop after 1 second
                    setTimeout(() => {
                        audioSource.stop();
                        addResult('‚èπÔ∏è Audio playback stopped');
                    }, 1000);
                } else {
                    addResult('‚ùå Audio playback failed to start', 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå Playback test failed: ${error.message}`, 'error');
                console.error('Playback test error:', error);
            }
        };
        
        window.clearResults = function() {
            resultsDiv.innerHTML = '';
        };
        
        // Auto-run basic tests on load
        setTimeout(runTests, 500);
    </script>
</body>
</html>
